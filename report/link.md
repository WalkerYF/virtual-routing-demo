# 使用tcp模拟链路层

这里写一下如何使用tcp来模拟链路层的实现。

## 适用网络物理拓扑结构

注意，为了简化问题，下面的链路层的实现仅限于这样的网络拓扑结构。

1. 多台路由器之间通过网线直连，中间没有其他的主机。

![](figure/2018-05-11-17-03-55.png)

## 接口

链路层应该给网络层提供以下接口

### 发送网络层的数据

网络层有IP包需要发送的时候，会将IP包送至链路层进行发送。
链路层会屏蔽线路中的各种细节，将该IP包发送至对应IP的主机。

1. 子网内不同IP地址的主机之间数据的发送

```py
DataLinkLayer.send(ip_pkg: bytes) -> error_code : int
# 将这个ip_pkg从该主机发往另一个主机
```

其中链路层会读取ip_pkg中的源ip和目的ip，并且尝试发送。
其中src_host是本机ip，dest_host是需要发送的主机的ip。

### 将链路层上收到的IP包向上交给网络层

链路层上的多个端口，都可能会收到IP包，链路层的工作是将这些IP包向上发送至网络层，由网络层进行解析。

```py
DataLinkLayer.receive()  -> ip_pkb : bytes
# 阻塞式收取IP包，会收到一个bytes类型的IP包
```

## IP package的格式

链路层应该按照以下的方式解析IP package，获取源ip和目的ip
注意：网络层保证给到链路层的ip包中的源IP和目的IP在同一个子网内。

参考标准IP数据包的格式
![](figure/2018-05-11-16-56-31.png)

其中选项固定为空，即没有

于是ip包的首部大小为5*32比特

|比特范围|值|
|-|-|
|0-15|/|
|16-31|数据包长度|
|32-47|/|
|48-63|子网比特数|
|64-95|/|
|96-127|源IP地址|
|128-159|最终目的IP地址|
|128-159|下一跳IP地址|

## 链路层底层实现

### 初始化链路

1. 使用host_register来初始化路由器间的链路
    1. host_register接受一个interface列表
    1. 拿到的每一个interface
        1. 每个interface建立一个监听线程
            1. 监听线程会accpet得到一个用于接受其他路由信息的socket
        1. 每个interface尝试连接对方
            1. 得到一个用于发送路由的socket
    1. 网线算是连上了

注意，这个host_register只适用于初始化路由器物理拓扑的过程。

TODO:暂时不能够处理网络中间拓扑改变的情况

1. 拔掉网线，一台路由器掉线？
1. 一台新的路由器想连网线

### send

由于链路层维护着每一个interface对应的socket
只需要找到对应的interface，然后使用其中的counter_socket发送即可。 

### receive

每一个interface都会有一个接受package的线程，它会从interface的client_socket中不断尝试接受IP包，一旦收到IP包，就会将这个IP包放到链路层的队列中，网络层就可以直接调用recv函数得到链路层收到的IP包

### 问题一：

如果有一台新的路由器上线，网络层如何知道？
网络层似乎不会知道链路层上有一个新的网线连接起来。
在现实情况中，也是这样的，链路层及以下只会维护该接口的up和down状态，关于该接口的所有信息由上层的协议存好吧？

新的路由器上线，将网线连到了其他路由器处，这在代码中应该如何实现？

1. 路由器一旦上线，会进行链路层的初始化，这其中，会为每一个端口创建一个监听线程，并且链路层还有一个线程用于主动与其他路由器建立连接。
    1. 新上线路由初始化每个端口的监听线程，ok
    1. 新路由，开始为自己的每一个接口尝试连接网线（建立socket）
        1. 会使用connect_all函数尝试连接所有预设的端口
        1. 连接得到的socket放到对应的host中，同时将该端口状态设置为up

适用情景：
在预设的网络拓扑中，每个路由器都会为每个预设的端口预留一个监听线程，这个监听线程会一直工作，直到有网线连上
因此能够做到，在已有预设网络拓扑的情况下，每个路由器能够异步的开启。

>结论：如果将网络拓扑写进了json文件，那么网络拓扑中路由器的上线能够成功

那么路由器的上线，如何通知给路由器网络层呢？

TODO:链路层中，connect_all函数中，对于每一个从down转up状态的端口，都将对应的信息放入一个报文中，放入队列，给网络层分析？？

### 问题二：

如果一台路由器下线，会怎样？
其他与该路由器相连的路由器，他们的socket就会失效，但是他们会不会知道呢？

需要解决的问题

1. 链路层需要得知每一个socket的状态，进而得知对面的路由器是否在工作
1. 链路层需要提供接口，关闭一个接口，并将关闭接口前将信息发送出去

### 需要补充实现

获取链路状态函数：show